---
title: Rotating Certificates
owner: Ops Manager
---

This topic describes how to check the expiration date of and rotate certificate authorities (CAs) and leaf certificates in <%= vars.product_name_full %> (<%= vars.product_name %>).

This includes the <%= vars.ops_manager %> root CA, BOSH NATS CA, and leaf certificates
in <%= vars.product_name %>) that are visible to the <%= vars.ops_manager %> API.

<p class='note warning'><strong>Warning:</strong> The rotation procedures described in this topic do not work if the certificates have already expired. If the certificates have expired, contact <a href="https://support.pivotal.io/">Pivotal Support</a> for guidance.</p>

For information about rotating IPsec certificates, see [Rotating IPsec Certificates](https://docs.pivotal.io/addon-ipsec/credentials.html).

## <a id='overview'></a> Overview

The <%= vars.ops_manager %> API manages and lists internal CAs and leaf certificates that enable <%= vars.product_name %> components to communicate with each other securely using TLS. It can also list certificates used externally, such as SAML certificates that authenticate to an external identity provider (IDP).

For more information about the CAs and leaf certificates visible to the <%= vars.ops_manager %> API, see [Certificate Types](certificate-types.html).

Rotate CAs and leaf certificates before they expire to avoid downtime for your foundation.


## <a id='procedure'></a> Procedure

This section explains how to rotate the <%= vars.ops_manager %> root CA, BOSH NATS CA, and leaf certificates in <%= vars.product_name %>.

<p class="note"><strong>Note:</strong> The BOSH NATS CA is automatically rotated when you rotate the <%= vars.ops_manager %> root CA. For more information, see <a href="./certificate-types.html">Certificate Types</a>.</p>

To rotate certificates in <%= vars.platform_name %>, you first check the expiration dates of all certificates. Then, based on the types of certificates that expire soon, you follow a certificate rotation procedure to replace expiring certificates and redeploy BOSH to apply changes.

To rotate CAs and leaf certificates:

1. Check the expiration dates of the <%= vars.ops_manager %> root CA and leaf certificates, and identify the types of leaf certificates that require rotation. For more information, see [Check Expiration Dates and Certificate Types](#checks).

1. Rotate the certificates that expire soon. For more information, see [Rotate Certificates](#rotate).


## <a id='checks'></a> Check Expiration Dates and Certificate Types

This section describes how to check the expiration dates of the CAs and leaf certificates that the <%= vars.ops_manager %> API lists and manages. It also explains how to identify the types of certificates that require manual rotation.

After identifying the types of certificates that expire soon, you can determine which certificate rotation procedure to follow.

### <a id='root-expiry'></a> Check Root CA Expiration Date

This procedure describes how to check the expiration date for the <%= vars.ops_manager %> root CA. The <%= vars.ops_manager %> root CA expires four years after creation.

To check the <%= vars.ops_manager %> root CA expiration date:

1. Follow the procedure in [Using <%= vars.ops_manager %> API](../../customizing/ops-man-api.html) to target and authenticate with the <%= vars.ops_manager %> User Account and Authentication (UAA) server. Record your <%= vars.ops_manager %> access token, and use it for `UAA-ACCESS-TOKEN` in the steps below.
  <p class="note"><strong>Note:</strong> When you record your <%= vars.ops_manager %> access token, remove any newline characters such as <code>\n</code>.</p>

1.  To retrieve the <%= vars.ops_manager %> certificates, use `curl` to call the `/deployed/certificates` endpoint of the <%= vars.ops_manager %> API. Run:

      ```
      curl "https://OPS-MANAGER-FQDN/api/v0/deployed/certificates" \
            -H "Authorization: Bearer UAA-ACCESS-TOKEN"
      ```
      Where:
      * `OPS-MANAGER-FQDN` is the fully-qualified domain name (FQDN) of your <%= vars.ops_manager %> deployment.
      * `UAA-ACCESS-TOKEN` is the `access_token` value you recorded in the previous step.
      <p class='note'><strong>Note:</strong> To make the JSON output more readable, pipe it to <a href="https://stedolan.github.io/jq/">jq</a> or another text editor with JSON formatting.</p>

1. In the `certificate_authorities` list returned, if there is more than one, find the CA with `"active": true`.

1. To determine the expiration date of the active CA, refer to its `expires_on` value. For example, the root CA shown below expires on September 5, 2019:
    <pre class='terminal'>
    {
      "certificate_authorities": [
        {
          "guid": "9c9a110c8f82a1e4aaca",
          "issuer": "Pivotal",
          "created_on": "2017-09-05T22:47:53Z",
          "expires_on": "2019-09-05T22:47:53Z",
          "active": true,
          "cert_pem": "\-\-\-\-\-BEGIN CERTIFICATE\-\-\-\-\-\
          [...]
          \n-----END CERTIFICATE\-\-\-\-\-\n"
    </pre>

### <a id='leaf-expiry'></a> Check Leaf Certificate Expiration Dates and Types

This procedure describes how to check the expiration dates of leaf certificates using the `deployed/certificates` endpoint. It also describes how to identify non-configurable, configurable, and non-rotatable leaf certificates in the output from the `deployed/certificates` endpoint.

To check the expiration dates of leaf certificates and identify the types of leaf certificates that expire soon:

1. If you have not already done so, follow the procedure in [Using <%= vars.ops_manager %> API](../../customizing/ops-man-api.html) to target and authenticate with the <%= vars.ops_manager %> UAA server. Record your <%= vars.ops_manager %> access token, and use it for `UAA-ACCESS-TOKEN` in the following steps.
  <p class="note"><strong>Note:</strong> When you record your <%= vars.ops_manager %> access token, remove any newline characters such as <code>\n</code>.</p>

1. To check the system for certificates that expire within a given time interval, run:

    ```
    curl "https://OPS-MANAGER-FQDN/api/v0/deployed/certificates?expires_within=TIME" \
          -H "Authorization: Bearer UAA-ACCESS-TOKEN"
    ```
    Where:
    * `OPS-MANAGER-FQDN` is the fully-qualified domain name (FQDN) of your <%= vars.ops_manager %> deployment.
    * `UAA-ACCESS-TOKEN` is the `access_token` value you recorded in the previous step.
    * `TIME` is integer-letter code.
        * Valid letter codes are `d` for days, `w` for weeks, `m` for months, and `y` for years.
        <br>
        For example, querying to `https://OPS-MANAGER-FQDN/api/v0/deployed/certificates?expires_within=6m` searches for certificates expiring within six months.
        <p class='note'><strong>Note:</strong> To make the JSON output more readable, pipe it to <a href="https://stedolan.github.io/jq/">jq</a> or another text editor with JSON formatting.</p>

1. To determine the expiration date of each certificate, see its `expires_on` value.

1. Identify the types of leaf certificates requiring rotation. The following rules identify the type of each leaf certificate:
  * **Non-rotatable certificates:** Non-rotatable leaf certificates have the following property value:
      * `variable_path` is `/opsmgr/bosh_dns/tls_ca`.
  * **Non-configurable certificates:** Non-configurable leaf certificates have the following property values and are not non-rotatable as identified above:
      * `configurable` is `false`.
      * `location` is either `ops_manager` or `credhub`.
  * **Configurable certificates:** Configurable leaf certificates have the following property value:
      * `configurable` is `true`.

1. Continue to [Rotate Certificates](#rotate) with your list of certificate types that expire soon.


## <a id='rotate'></a> Rotate Certificates

This section includes procedures for rotating CAs and leaf certificates. There are different rotation procedures for each type of certificate that requires rotation.

You can determine which rotation procedure to follow based on the types of certificates in your foundation that must be rotated. For more information about identifying the types of certificates in your foundation that expire soon, see [Check Expiration Dates and Certificate Types](#checks).

To rotate certificates, follow one of these procedures:

* To rotate non-rotatable certificates, contact [Pivotal Support](http://support.pivotal.io).

* To rotate CAs stored in <%= vars.ops_manager %>, see [Rotate the Root CA and Leaf Certificates](#rotate-ca). This procedure also rotates the BOSH NATS CA.

* To rotate non-configurable leaf certificates, but not the <%= vars.ops_manager %> root CA or BOSH NATS CA, see [Rotate Non-Configurable Leaf Certificates](#regenerate).

* To rotate configurable leaf certificates, but not the <%= vars.ops_manager %> root CA or BOSH NATS CA, see [Rotate Configurable Leaf Certificates](#rotate-config).

* To rotate the <code>/services/tls_ca</code> certificate, see <a href="services_tls_ca_rotate.html">Rotating the Services TLS CA and Its Leaf Certificates</a>.

### <a id='rotate-ca'></a> Rotate the Root CA and Leaf Certificates

<p class="note warning"><strong>Warning:</strong> The Services CA certificate, <code>/services/tls_ca</code>,
cannot be rotated using this procedure. For information about how to rotate the <code>/services/tls_ca</code>
certificate, see <a href="services_tls_ca_rotate.html">Rotating the Services TLS CA and Its Leaf Certificates</a>.</p>

This procedure uses the <%= vars.ops_manager %> API to rotate the <%= vars.ops_manager %> root CA
and non-configurable leaf certificates. When you rotate the <%= vars.ops_manager %> root CA, the
<%= vars.ops_manager %> API automatically rotates the BOSH NATS CA.

If you used the **Generate RSA Certificate** feature to rotate the configurable certificates, this
procedure instructs you to rotate the configurable leaf certificates by regenerating them.

To prevent system downtime, this procedure includes two BOSH deploys. The first BOSH deploy applies
new certificates to <%= vars.product_name %> components. The second BOSH deploy deletes the old
certificates.

<p class='note'><strong>Note:</strong> The names of the <strong>Upgrade All Service Instances</strong> and <strong>Recreate All Service Instances</strong> errands may be slightly different between services.</p>

<p class="note warning"><strong>Warning:</strong> You must complete these steps in the exact order specified. Otherwise, you may damage your deployment.</p>

To rotate the <%= vars.ops_manager %> root CA and leaf certificates:

1. Add a new <%= vars.ops_manager %> root CA. For more information, see [Add a New Root CA](#add-new-ca).

1. Activate the <%= vars.ops_manager %> root CA. For more information, see [Activate the Root CA](#activate-new-ca).

1. Rotate leaf configurable certificates.
   For more information, see [Rotate Configurable Leaf Certificates](#rotate-config-after-new-root).

1. Rotate non-configurable leaf certificates. For more information, see [Rotate Non-Configurable Leaf Certificates from the New Root CA](#regenerate-from-new-root).

1. Delete the old root CA. For more information, see [Delete the Old Root CA](#delete).

#### <a id='add-new-ca'></a> Step 1: Add a New Root CA

This section describes how to add a new root CA for <%= vars.ops_manager %>. The new root CA can be a Pivotal-generated CA or your own custom CA.

This procedure also automatically regenerates the BOSH NATS CA.

<p class="note warning"><strong>Warning:</strong>The CAs for certain versions of the MySQL, Redis,
RabbitMQ, and Pivotal Cloud Cache tiles are excluded from rotation. See the tile-specific documentation for
information about rotating these CAs.</p>

To add a new root CA for <%= vars.ops_manager %> and regenerate the BOSH NATS CA:

1. If you have not already done so, follow the procedure in [Using <%= vars.ops_manager %> API](../../customizing/ops-man-api.html) to target and authenticate with the <%= vars.ops_manager %> UAA server. Record your <%= vars.ops_manager %> access token, and use it for `UAA-ACCESS-TOKEN` in the following steps.
  <p class="note"><strong>Note:</strong> When you record your <%= vars.ops_manager %> access token, remove any newline characters such as <code>\n</code>.</p>

1. Use <%= vars.ops_manager %> to generate a new CA, or add your own custom CA:
  <p class ="note"><strong>Note:</strong> Elliptic Curve Digital Signature Algorithm (ECDSA) certificates are not supported in <%= vars.product_name %>.</p>
  * **To use your own custom CA:** Call the <%= vars.ops_manager %> API `certificate_authorities` endpoint. Run:

          ```
          curl "https://OPS-MANAGER-FQDN/api/v0/certificate_authorities" \
              -X POST \
              -H "Authorization: Bearer UAA-ACCESS-TOKEN" \
              -H "Content-Type: application/json" \
              -d '{"cert_pem": "-----BEGIN CERTIFICATE-----\CUSTOM-CERTIFICATE", "private_key_pem": "-----BEGIN RSA PRIVATE KEY-----\RSA-KEY"}'
          ```
          Where:
          * `OPS-MANAGER-FQDN` is the FQDN of your <%= vars.ops_manager %> deployment.
          * `CUSTOM-CERTIFICATE` is your custom CA.
          * `RSA-KEY` is your RSA key.
          * `UAA-ACCESS-TOKEN` is your UAA access token.
          <br>
          <br>
          If the command succeeds, the API returns a response that includes the new CA certificate. For example:
          <pre class="terminal">
            HTTP/1.1 200 OK
            {
              "certificate_authorities": [
                {
                  "guid": "f7bc18f34f2a7a9403c3",
                  "issuer": "YOUR-CA",
                  "created_on": "2017-01-09",
                  "expires_on": "2021-01-09",
                  "active": true,
                  "cert_pem": "-----BEGIN CERTIFICATE-----\nMIIC+zCCAeOgAwIBAgI....etc"
                }
              ]
            }
          </pre>
    * **To use a Pivotal-generated CA:** Call the <%= vars.ops_manager %> API `generate` endpoint. Run:

          ```
          curl "https://OPS-MANAGER-FQDN/api/v0/certificate_authorities/generate" \
                -X POST \
                -H "Authorization: Bearer UAA-ACCESS-TOKEN" \
                -H "Content-Type: application/json" \
                -d '{}'
          ```
          Where:
          * `OPS-MANAGER-FQDN` is the FQDN of your <%= vars.ops_manager %> deployment.
          * `UAA-ACCESS-TOKEN` is your UAA access token.
          </br>
          </br>
          If the command succeeds, the API returns a response that includes the new CA certificate. For example:
          <pre class="terminal">
              HTTP/1.1 200 OK
          {
              "guid": "f7bc18f34f2a7a9403c3",
              "issuer": "Pivotal",
              "created_on": "2017-01-19",
              "expires_on": "2021-01-19",
              "active": false,
              "cert_pem": "-----BEGIN EXAMPLE CERTIFICATE-----
              MIIC+zCCAeOgAwIBAgIBADANBgkqhkiG9w0BAQsFADAfMQswCQYDVQQGEwJVUzEQ
              EXAMPLEoCgwHUGl2b3RhbDAeFw0xNDarthgyMTQyMjVaFw0yMTAxMTkyMTQyMjVa
              EXAMPLEoBgNVBAYTAlVTMRAwDgYDVVaderdQaXZvdGFsMIIBIjANBgkqhkiG9w0B
              EXAMPLEoAQ8AMIIBCgKCAQEAyV4OhPIIZTEym9OcdcNVip9Ev0ijPPLo9WPLUMzT
              EXAMPLEo/TgD+DP09mwVXfqwBlJmoj9DqRED1x/6bc0Ki/BAFo/P4MmOKm3QnDCt
              EXAMPLEooqgA++2HYrNTKWJ5fsXmERs8lK9AXXT7RKXhktyWWU3oNGf7zo0e3YKp
              EXAMPLEoh1NwIbNcGT1AurIDsxyOZy1HVzBLTisMyDogJmSCLsOw3qUDQjatjXKw
              EXAMPLEojG3nv2hvD4/aTOiHuKM3+AGbnaS2MdIOvFOh/7Y79tUp89csK0gs6uOd
              EXAMPLEohe4DcKw5CzUTfHKNXgHyeoVOBPcVQTp4lJp1iQIDAQABo0IwQDAdBgNV
              EXAMPLEoyH4y7VEuImLStXM0CKR8uVqxX/gwDwYDVR0TAQH/BAUwAwEB/zAOBgNV
              EXAMPLEoBAMCAQYwDQYJKoZIhvcNAQELBQADggEBALmHOPxdyBGnuR0HgR9V4TwJ
              EXAMPLEoGLKVT7am5z6G2Oq5cwACFHWAFfrPG4W9Jm577QtewiY/Rad/PbkY0YSY
              EXAMPLEokrfNjxjxI0H2sr7qLBFjJ0wBZHhVmDsO6A9PkfAPu4eJvqRMuL/xGmSQ
              EXAMPLEoCynMNz7FgHyFbd9D9X5YW8fWGSeVBPPikcONdRvjw9aEeAtbGEh8eZCP
              EXAMPLEob33RuR+CTNqThXY9k8d7/7ba4KVdd4gP8ynFgwvnDQOjcJZ6Go5QY5HA
              EXAMPLEoPFW8pAYcvWrXKR0rE8fL5o9qgTyjmO+5yyyvWIYrKPqqIUIvMCdNr84=
                -----END EXAMPLE CERTIFICATE-----
                "
          </pre>

1. Confirm that the new CA is added by listing all the root CAs for <%= vars.ops_manager %> by running:

      ```
      curl "https://OPS-MANAGER-FQDN/api/v0/certificate_authorities" \
            -X GET \
            -H "Authorization: Bearer UAA-ACCESS-TOKEN"
      ```
      Where:
      * `OPS-MANAGER-FQDN` is the FQDN of your <%= vars.ops_manager %> deployment.
      * `UAA-ACCESS-TOKEN` is your UAA access token.
      </br>
      </br>
    The API call returns the GUID of the newly added CA. For example:
      <pre class="terminal">
        HTTP/1.1 200 OK
          {
            "certificate_authorities": [
              {
                "guid": "f7bc18f34f2a7a9403c3",
                "issuer": "Pivotal",
                "created_on": "2017-01-09",
                "expires_on": "2021-01-09",
                "active": true,
                "cert_pem": "-----BEGIN CERTIFICATE-----\nMIIC+zCCAeOgAwIBAgI....etc"
              }
              {
                "guid": "a8ee01e33e3e3e3303e3",
                "issuer": "Pivotal",
                "created_on": "2017-04-09",
                "expires_on": "2021-04-09",
                "active": false,
                "cert_pem": "-----BEGIN CERTIFICATE-----\nzBBBC+eAAAe1gAwAAAeZ....etc"
                    }
                  ]
              }
        </pre>

1. Identify the newly added CA, which has `active` set to `false`. Record its GUID.

1. Navigate to `https://OPS-MANAGER-FQDN` in a browser, where `OPS-MANAGER-FQDN` is the FQDN of your <%= vars.ops_manager %> deployment.

1. Log in to <%= vars.ops_manager %>.

1. Click the BOSH Director tile.

1. Select **Director Config**.

1. Enable the **Recreate All VMs** checkbox. This propagates the new CA to all VMs deployed by the BOSH Director to prevent downtime.

1. Return to the <%= vars.ops_manager %> Installation Dashboard.

1. If you have service tiles installed, for each service tile:
    1. Click the tile.
    1. Click the **Errands** tab.
    1. Enable the **Upgrade All Service Instances** errand. Running this errand is necessary to push CredHub certificate updates to each service instance.
    1. If the service tile has the **Recreate All Service Instances** errand:
        1. Enable the **Recreate All Service Instances** errand.
        1. Click **Review Pending Changes**.
        1. Click **Apply Changes**.
    1. If the service tile does not have the **Recreate All Service Instances** errand:
        1. Click **Review Pending Changes**.
        1. Click **Apply Changes**.
        1. When the deploy finishes, manually push the BOSH NATS CA to each of its service instances. For each service instance, run:

            ```
            bosh -d SERVICE-INSTANCE-DEPLOYMENT recreate
            ```
            Where `SERVICE-INSTANCE-DEPLOYMENT` is the BOSH deployment name for the service instance.
            
1. If you do not have any service tiles installed:
    1. Click **Review Pending Changes**.
    1. Click **Apply Changes**.

1. When the deploy finishes and you have completed all necessary tasks to update service instances, continue to the next section, [Activate the Root CA](#activate-new-ca).

#### <a id='activate-new-ca'></a> Step 2: Activate the Root CA

To activate the new root CA:

1. Make an <%= vars.ops_manager %> API call that activates the new CAs. Run:

    ```
    curl "https://OPS-MANAGER-FQDN/api/v0/certificate_authorities/CERTIFICATE-GUID/activate" \
      -X POST \
      -H "Authorization: Bearer UAA-ACCESS-TOKEN" \
      -H "Content-Type: application/json" \
      -d '{}'
    ```
    Where:
    * `OPS-MANAGER-FQDN` is the FQDN of your <%= vars.ops_manager %> deployment.
    * `CERTIFICATE-GUID` is the GUID of your CA that you retrieved in the previous section.
    * `UAA-ACCESS-TOKEN` is your UAA access token.
    </br>
    </br>
    The API returns a successful response:
    <pre class="terminal">HTTP/1.1 200 OK</pre>

1. List your root CAs again to confirm that the new <%= vars.ops_manager %> root CA is active. Run:

    ```
    curl "https://OPS-MANAGER-FQDN/api/v0/certificate_authorities" \
          -X GET \
          -H "Authorization: Bearer UAA-ACCESS-TOKEN"
    ```
    Where:
    * `OPS-MANAGER-FQDN` is the FQDN of your <%= vars.ops_manager %> deployment.
    * `UAA-ACCESS-TOKEN` is your UAA access token.

1. Examine the response to ensure that your new CA has the `active` property set to `true`.

#### <a id='rotate-config-after-new-root'></a> Step 3: Rotate Configurable Leaf Certificates

Any configurable certificates generated from the <%= vars.ops_manager %> root CA must be rotated. These are the certificates that you generated using **Generate RSA Certificate** in the <%= vars.ops_manager %> UI. For example, see [Providing a Certificate for Your TLS Termination Point](https://docs.pivotal.io/pivotalcf/2-6/opsguide/security_config.html).

To regenerate and rotate configurable leaf certificates, do the following for each configurable certificate that expires soon:

1. Find the text field where the certificate is configured within the <%= vars.ops_manager %> interface. You might need to look through multiple configuration panes to identify the location of the certificate configuration text field. Use the following fields to identify the location of the certificate configuration text field:
  * The `product_guid` field in the <%= vars.ops_manager %> API output can help identify in which tile the certificate is configured. For example, the prefix `p-bosh-` refers to the BOSH Director tile, and the prefix `cf-` refers to the <%= vars.product_runtime %> (<%= vars.product_short %>) tile.
  * The `property_reference` field in the API output can help identify in which **Settings** pane the certificate is configured. For example, the `uaa.service_provider_key_credentials` property is configured in the **UAA** pane of the <%= vars.product_short %> tile.

1. Copy a new value for the certificate into the text field or generate a new certificate using the
**Generate RSA Certificate** button.

1. Click **Save** at the bottom of each pane in which you added new certificates.

#### <a id='regenerate-from-new-root'></a> Step 4: Rotate Non-Configurable Leaf Certificates from the New Root CA

After activating the new <%= vars.ops_manager %> root CA, you must rotate non-configurable leaf certificates from the new root CA.

To rotate non-configurable leaf certificates from the new root CA:

1. Make a call to the <%= vars.ops_manager %> API to regenerate all non-configurable certificates and apply the new root CA to your existing BOSH Director. Run:

    ```
      curl "https://OPS-MANAGER-FQDN/api/v0/certificate_authorities/active/regenerate" \
            -X POST \
            -H "Authorization: Bearer UAA-ACCESS-TOKEN" \
            -H "Content-Type: application/json" \
            -d '{}'
    ```
    Where:
    * `OPS-MANAGER-FQDN` is the FQDN of your <%= vars.ops_manager %> deployment.
    * `UAA-ACCESS-TOKEN` is your UAA access token.
    <br>
    <br>
    The API returns a successful response:
    <pre class="terminal">HTTP/1.1 200 OK</pre>

1. Navigate to the <%= vars.ops_manager %> Installation Dashboard.

1. Click the BOSH Director tile.

1. Select **Director Config**.

1. Enable the **Recreate All VMs** checkbox. This propagates the new CAs to all VMs deployed by the BOSH Director to prevent downtime.

1. Return to the <%= vars.ops_manager %> Installation Dashboard.

1. If you have service tiles installed, for each service tile:
    1. Click the tile.
    1. Click the **Errands** tab.
    1. Enable the **Upgrade All Service Instances** errand. Running this errand is necessary to push CredHub certificate updates to each service instance.
    1. If the service tile has the **Recreate All Service Instances** errand:
        1. Enable the **Recreate All Service Instances** errand.
        1. Click **Review Pending Changes**.
        1. Click **Apply Changes**.
    1. If the service tile does not have the **Recreate All Service Instances** errand:
        1. Click **Review Pending Changes**.
        1. Click **Apply Changes**.
        1. When the deploy finishes, manually push the BOSH NATS CA to each of its service instances. For each service instance, run:

            ```
            bosh -d SERVICE-INSTANCE-DEPLOYMENT recreate
            ```
            Where `SERVICE-INSTANCE-DEPLOYMENT` is the BOSH deployment name for the service instance.
            
1. If you do not have any service tiles installed:
    1. Click **Review Pending Changes**.
    1. Click **Apply Changes**.

1. When the deploy finishes and you have completed all necessary tasks to update service instances, continue to the next section, [Delete the Old Root CA](#delete).

#### <a id='delete'></a> Step 5: Delete the Old Root CA

After activating new CAs and rotating leaf certificates from the new CAs, you should delete the old <%= vars.ops_manager %> root CA from your foundation.

If your old root CA or leaf certificates have been compromised, you must delete the old root CA immediately. Otherwise, the old root CA and its leaf certificates may still be trusted, which compromises your foundation's security. If your old root CA or leaf certificates have not been compromised, <%= vars.recommended_by %> recommends that you delete the old root CA as soon as possible, but you can also delete it at a later time, such as in conjunction with another deploy.

<p class="note warning"><strong>Warning:</strong> Before you delete the old CA, ensure that you reviewed the <strong>Review Pending Changes</strong> page and clicked <strong>Apply Changes</strong> as part of <a href="#regenerate-from-new-root">Rotate Non-Configurable Leaf Certificates from the New CAs</a>.</p>

To delete the old <%= vars.ops_manager %> root CA:

1. List your root CAs to retrieve the GUID of the old, inactive <%= vars.ops_manager %> root CA. Run:

    ```
    curl "https://OPS-MANAGER-FQDN/api/v0/certificate_authorities" \
          -X GET \
          -H "Authorization: Bearer UAA-ACCESS-TOKEN"
    ```
    Where:
    * `OPS-MANAGER-FQDN` is the FQDN of your <%= vars.ops_manager %> deployment.
    * `UAA-ACCESS-TOKEN` is your UAA access token.

1. Use `curl` to make an API call to delete the old <%= vars.ops_manager %> root CA. Run:

    ```
    curl "https://OPS-MANAGER-FQDN/api/v0/certificate_authorities/OLD-CERTIFICATE-GUID" \
          -X DELETE \
          -H "Authorization: Bearer UAA-ACCESS-TOKEN"
    ```
    Where:
    * `OPS-MANAGER-FQDN` is the FQDN of your <%= vars.ops_manager %> deployment.
    * `OLD-CERTIFICATE-GUID` is the GUID of the old <%= vars.ops_manager %> root CA.
    * `UAA-ACCESS-TOKEN` is your UAA access token.
    </br>
    </br>
    The API returns a successful response:
    <pre class="terminal">HTTP/1.1 200 OK</pre>

1. Navigate to the <%= vars.ops_manager %> Installation Dashboard.

1. Click the BOSH Director tile.

1. Select **Director Config**.

1. Enable the **Recreate All VMs** checkbox.

1. Navigate to the <%= vars.ops_manager %> Installation Dashboard.

1. If you have service tiles installed, for each service tile:
    1. Click the tile.
    1. Click the **Errands** tab.
    1. Enable the **Upgrade All Service Instances** errand. Running this errand is necessary to push CredHub certificate updates to each service instance.
    1. If the service tile has the **Recreate All Service Instances** errand:
        1. Enable the **Recreate All Service Instances** errand. Running this errand pushes BOSH agent certificate updates to service instances.
        1. Click **Review Pending Changes**.
        1. Click **Apply Changes**.
    1. If the service tile does not have the **Recreate All Service Instances** errand:
        1. Click **Review Pending Changes**.
        1. Click **Apply Changes**.
        1. When the deploy finishes, manually push BOSH agent certificate updates to each service instance. For each service instance, run:

            ```
            bosh -d SERVICE-INSTANCE-DEPLOYMENT recreate
            ```
            Where `SERVICE-INSTANCE-DEPLOYMENT` is the BOSH deployment name for the service instance.

1. If you do not have any service tiles installed:
    1. Click **Review Pending Changes**.
    1. Click **Apply Changes**.

### <a id='regenerate'></a> Rotate Non-Configurable Leaf Certificates

This procedure rotates non-configurable leaf certificates visible to the <%= vars.ops_manager %> API, whether they are managed and stored by <%= vars.ops_manager %> directly, or by CredHub at <%= vars.ops_manager %>'s request.

<p class='note warning'><strong>Warning:</strong> This procedure does not rotate the <%= vars.ops_manager %> root CA. To rotate both the root CA and non-configurable leaf certificates, see <a href="#rotate-ca">Rotate CAs and Leaf Certificates</a>.</p>

To rotate non-configurable leaf certificates:

1. Make a call to the <%= vars.ops_manager %> API to regenerate all non-configurable certificates and apply the new CA to your existing BOSH Director. Run:

    ```
    curl "https://OPS-MANAGER-FQDN/api/v0/certificate_authorities/active/regenerate" \
          -X POST \
          -H "Authorization: Bearer UAA-ACCESS-TOKEN" \
          -H "Content-Type: application/json" \
          -d '{}'
    ```
    Where:
    * `OPS-MANAGER-FQDN` is the FQDN of your <%= vars.ops_manager %> deployment.
    * `UAA-ACCESS-TOKEN` is your UAA access token.
    </br>
    </br>
    The API returns a successful response:
    <pre class="terminal">HTTP/1.1 200 OK</pre>

1. Navigate to the <%= vars.ops_manager %> Installation Dashboard.

1. Click **Review Pending Changes**.

1. Verify that the affected products are selected and click **Apply Changes** to start the deployment.

### <a id='rotate-config'></a> Rotate Configurable Leaf Certificates

Configurable certificates are generated by the user and pasted into <%= vars.ops_manager %> configuration panes where needed. Examples include certificates that terminate SSL traffic into <%= vars.product_short %>, or authenticate a Single Sign-On (SSO) for <%= vars.product_name %> service plan to an external SAML server.

For instructions on how to rotate SAML certificates for both <%= vars.product_short %> and the SSO service, see [Rotate Identity Provider SAML Certificates](#rotate-saml-ca).

<p class="note warning"><strong>Warning:</strong> This procedure does not rotate the <%= vars.ops_manager %> root CA. To rotate both the root CA and non-configurable leaf certificates, see <a href="#rotate-ca">Rotate CAs and Leaf Certificates</a>.</p>

To rotate configurable leaf certificates:

1. If you have not already done so, use the <%= vars.ops_manager %> API `deployed/certificates` endpoint to retrieve information about your expiring configurable certificates, as described in the procedures in [Check Expiration Dates and Certificate Types](#checks). The information for each configurable certificate looks like the following example:
  <pre class="terminal">
    {
      "configurable": true,
      "property_reference": ".properties.networking_poe_ssl_certs[0].certificate",
      "property_type": "rsa_cert_credentials",
      "product_guid": "cf-36066831c119c39736d3",
      ...
      "valid_until": "2019-01-25T22:07:58Z"
    },
  </pre>

1. For each configurable certificate that expires soon:
  1. Find the text field the certificate is configured within the <%= vars.ops_manager %> interface.
      * The `product_guid` field in the API output can help identify which tile the certificate is configured in. For example, the prefix `p-bosh-` refers to the BOSH Director tile, and the prefix `cf-` refers to the <%= vars.product_short %> tile.
      * The `property_reference` field in the API output can often help identify which **Settings** pane the certificate is configured in. For example, the `uaa.service_provider_key_credentials` property is configured in the **UAA** pane of the <%= vars.product_short %> tile.
      * You might need to look through multiple configuration panes to identify where a certificate is configured.
  1. Paste a new value for the certificate into the field.
  1. Click **Save** at the bottom of each pane in which you have provided new certificates.

1. If you are rotating configurable certificates within the [Rotate CAs and Leaf Certificates](#rotate-ca) procedure, continue to the next step. Otherwise, if you are rotating configurable leaf certificates only:
  1. Return to the <%= vars.ops_manager %> Installation Dashboard.
  1. Click **Review Pending Changes**.
  1. Click **Apply Changes**.

### <a id='rotate-saml-ca'></a> Rotate Identity Provider SAML Certificates

SAML service provider (SP) credentials are one example of configurable certificates in <%= vars.product_short %>. When <%= vars.product_short %> is configured to use SAML as an IDP, it uses a configurable CA certificate to authenticate to an external SAML server, by generating ephemeral certificates that <%= vars.product_short %> includes in its outbound request message headers. This CA has a two-year expiration period.

In addition, the SSO service shares the use of <%= vars.product_short %> SAML certificates for every SAML external IDP integration, such as trust, partnership, or federation. You must rotate these in lockstep with <%= vars.product_short %>.

The following procedure provides an example of how to rotate certificates for each IDP, including temporarily disabling certificate validation on the IDP side during the rotation.

For more information about rotating SAML certificates, see [PCF Advisory - SAML Service Provider Credential Certificates Expire after 2 Years](https://community.pivotal.io/s/article/PCF-Advisory---SAML-Service-Provider-Credential-Certificates-Expire-after-2-Years) in the Pivotal Knowledge Base.

SAML SP credentials are only required for your <%= vars.product_short %> deployment if all of these conditions are met:

* You are using SSO in production for login to <%= vars.product_short %> or using the SSO service for login to apps.

* You are using SAML IDPs for <%= vars.product_short %> or SSO service plans.

* You had <%= vars.ops_manager %> generate a certificate for you by clicking the **Generate RSA Certificate** button.

* You are validating the signature of SAML authentication request with your IDP.

To regenerate and rotate SAML service provider certificates without disrupting <%= vars.product_short %> or your apps using the SSO service:

1. Disable certificate validation in your IDP.

1. For <%= vars.product_short %>, follow the procedure in the table below that corresponds to your use case. This includes downloading and importing a new certificate and updated SAML metadata in your IDP.
  <table border="1">
  <tr>
    <th>Solution Name</th>
    <th>Procedure</th>
  </tr>
  <tr>
    <td><a href='https://www.ca.com/us/securecenter/ca-single-sign-on.aspx'>CA Single Sign-On aka CA SiteMinder</a></td>
    <td><a href="../../opsguide/ca-sso-config.html">Configuring CA as an Identity Provider</a></td>
  </tr>
  <tr>
    <td><a href='https://www.pingidentity.com/en/products/pingfederate.html'>PingFederate</a></td>
    <td><a href="../../opsguide/ping-federate-sso-configuration.html">Configuring PingFederate as an Identity Provider</a></td>
  </tr>
  <tr>
    <td><a href='https://technet.microsoft.com/en-us/windowsserver/dd448613.aspx'>Active Directory Federation Services (AD FS)</a></td>
    <td><a href="../../opsguide/adfs-sso-configuration.html">Configuring AD FS as an Identity Provider</a></td>
  </tr>
</table>

1. For the SSO service, follow the procedure in the table below that corresponds to your use case. This includes downloading the SAML SP metadata for each SAML IDP integration, such as trust, partnership, or federation, and importing the updated SAML SP metadata in your IDP.
  <table border="1">
  <tr>
    <th>Solution Name</th>
    <th>Procedure</th>
  </tr>
  <tr>
    <td>AD FS</td>
    <td><a href="https://docs.pivotal.io/p-identity/adfs/config-sso.html">Configuring a Single Sign-On Service Provider</a></td>
  </tr>
  <tr>
    <td>CA SSO</td>
    <td><a href="https://docs.pivotal.io/p-identity/ca-sso/config-sso.html">Configuring a Single Sign-On Service Provider</a></td>
  </tr>
  <tr>
    <td>Okta</td>
    <td><a href="https://docs.pivotal.io/p-identity/okta/config-sso.html">Configure Okta as an Identity Provider</a></td>
  </tr>
  <tr>
    <td>PingFederate</td>
    <td><a href="https://docs.pivotal.io/p-identity/pingfederate/config-sso.html">Configure PingFederate as an Identity Provider</a></td>
  </tr>
  <tr>
    <td>Additional Documentation</td>
    <td><a href="https://docs.pivotal.io/p-identity/index.html#guides">Integration Guides</a></td>
  </tr>
  </table>

1. Re-enable certificate validation in your IDP.
